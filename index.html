<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Misk Schools Bell Curve Generator</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- For PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root {
      --misk-dark-green: #00372A;
      --misk-petroleum: #00635B;
      --misk-sand: #F5F0E8;
      --misk-text: #222222;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 24px;
      background: #f5f5f7;
      color: var(--misk-text);
    }

    .app-shell {
      max-width: 1150px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
      padding: 20px 24px 24px;
      border-top: 6px solid var(--misk-dark-green);
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 12px;
    }

    .app-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .app-header img {
      height: 56px;
      width: auto;
    }

    .app-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--misk-dark-green);
    }

    .app-subtitle {
      font-size: 0.9rem;
      color: #4b5563;
    }

    .badge {
      background: var(--misk-sand);
      color: var(--misk-dark-green);
      padding: 4px 10px;
      font-size: 0.75rem;
      border-radius: 999px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-weight: 600;
    }

    textarea {
      width: 100%;
      min-height: 96px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #CBD5E1;
      font-family: inherit;
      font-size: 0.95rem;
      resize: vertical;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin: 10px 0 4px;
    }

    .controls label {
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .controls input[type="number"] {
      width: 90px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #CBD5E1;
      font-family: inherit;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    button {
      padding: 8px 15px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--misk-dark-green);
      color: #ffffff;
    }
    .btn-primary:hover {
      background: var(--misk-petroleum);
    }

    .btn-secondary {
      background: #E5F2EE;
      color: var(--misk-dark-green);
    }
    .btn-secondary:hover {
      background: #D4EBE4;
    }

    .btn-ghost {
      background: transparent;
      color: var(--misk-dark-green);
      border: 1px solid #D1D5DB;
    }
    .btn-ghost:hover {
      background: #F3F4F6;
    }

    .hint {
      font-size: 0.8rem;
      color: #6B7280;
      margin-top: 2px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 24px;
      margin-top: 18px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .app-shell {
        padding: 16px;
      }
      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    canvas {
      background: #ffffff;
      border-radius: 10px;
      height: 280px !important;
      border: 1px solid #E5E7EB;
      margin-bottom: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 6px;
    }

    th, td {
      border: 1px solid #E5E7EB;
      padding: 5px 6px;
      text-align: left;
    }

    th {
      background: #F3F4F6;
      font-weight: 600;
    }

    .subheading {
      font-weight: 600;
      margin-top: 8px;
      margin-bottom: 2px;
      font-size: 0.95rem;
      color: #111827;
    }

    .footer {
      margin-top: 14px;
      font-size: 0.75rem;
      color: #9CA3AF;
      text-align: right;
    }
  </style>
</head>
<body>
<div class="app-shell" id="appRoot">
  <header class="app-header">
    <div class="app-header-left">
      <!-- Make sure misk-logo.png is in the repo root -->
      <img src="misk-logo.png" alt="Misk Schools logo" />
      <div>
        <div class="app-title">Bell Curve Generator</div>
        <div class="app-subtitle">Assessment and Data · Misk Schools</div>
      </div>
    </div>
    <span class="badge">Internal tool</span>
  </header>

  <p style="font-size:0.9rem; margin-top:0;">
    Paste student scores, enter total marks, then generate fitted normal curves with performance bands. The first chart shows Emerging to Exemplary, the second shows grades 1 to 9.
  </p>

  <textarea id="scoresInput">36, 33, 21, 26, 36, 15, 27, 40, 42, 30, 37, 31, 29, 30, 38.5, 36.5, 44, 45, 32, 38.5, 35.5, 32, 26</textarea>

  <div class="controls">
    <label>
      Total marks:
      <input type="number" id="maxMarks" value="55" min="1" />
    </label>
  </div>

  <div class="btn-row">
    <button class="btn-primary" onclick="generateCurve()">Generate</button>
    <button class="btn-secondary" onclick="resetInputs()">Reset</button>
    <button class="btn-ghost" onclick="downloadPDF()">Download as PDF</button>
  </div>
  <div class="hint">
    Reset clears the inputs. The current charts stay in view until you generate again.
  </div>

  <div class="grid">
    <div>
      <p class="subheading">Bell curve - Emerging to Exemplary bands</p>
      <canvas id="curveChart"></canvas>

      <p class="subheading" style="margin-top:4px;">Bell curve - 1 to 9 grading scale</p>
      <canvas id="stanineChart"></canvas>
    </div>
    <div>
      <p class="subheading">Summary statistics</p>
      <div id="summary"></div>

      <p class="subheading">Performance bands (Emerging to Exemplary)</p>
      <table id="bandsTable"></table>

      <p class="subheading">1 to 9 grade distribution</p>
      <table id="stanineTable"></table>

      <p class="subheading">Student scores with Emerging to Exemplary band</p>
      <table id="studentsTable"></table>
    </div>
  </div>

  <div class="footer">
    Misk Schools · Assessment and Data · Bell curve generator
  </div>
</div>

<script>
  let chartInstance = null;
  let stanineChartInstance = null;

  function parseScores(text) {
    return text.split(/[\s,]+/).map(v => parseFloat(v)).filter(v => !isNaN(v));
  }

  function stats(arr) {
    const n = arr.length;
    const mean = arr.reduce((a,b)=>a+b,0)/n;
    const sd = Math.sqrt(arr.reduce((a,b)=>a+(b-mean)**2,0)/n);
    return { n, mean, sd, min: Math.min(...arr), max: Math.max(...arr) };
  }

  function normalPdf(x, mu, sigma) {
    return (1/(sigma*Math.sqrt(2*Math.PI))) * Math.exp(-0.5*((x-mu)/sigma)**2);
  }

  function generateCurve(){
    const scores = parseScores(document.getElementById("scoresInput").value);
    const maxMarks = parseFloat(document.getElementById("maxMarks").value);

    if(scores.length < 3 || isNaN(maxMarks) || maxMarks <= 0) {
      alert("Please enter at least 3 valid scores and a positive total marks value.");
      return;
    }

    const { n, mean, sd, min, max } = stats(scores);

    // Range for charts - mean ± 2SD, bounded by 0 and total marks
    let xMin = Math.max(0, mean - 2*sd);
    let xMax = Math.min(maxMarks, mean + 2*sd);
    if (xMax <= xMin) {
      xMin = Math.max(0, min - 2);
      xMax = Math.min(maxMarks, max + 2);
    }

    // Curve points
    const xs=[], ys=[];
    let maxY=0;
    for(let i=0;i<200;i++){
      const x = xMin + i*(xMax-xMin)/199;
      const y = normalPdf(x, mean, sd);
      xs.push(x);
      ys.push(y);
      if(y>maxY) maxY=y;
    }

    // 5-band Emerging to Exemplary
    const bands5 = {
      "Emerging":[0, mean - sd],
      "Developing":[mean - sd, mean - 0.5*sd],
      "Secured":[mean - 0.5*sd, mean + 0.5*sd],
      "Proficient":[mean + 0.5*sd, mean + sd],
      "Exemplary":[mean + sd, maxMarks]
    };

    // 1-9 bands based on z-scores (stanine-style)
    const stanineZ = [-Infinity, -1.75, -1.25, -0.75, -0.25, 0.25, 0.75, 1.25, 1.75, Infinity];
    const stanineBands = {};
    for (let grade = 1; grade <= 9; grade++) {
      const zLow = stanineZ[grade - 1];
      const zHigh = stanineZ[grade];
      const rawLow = mean + zLow * sd;
      const rawHigh = mean + zHigh * sd;
      stanineBands[grade] = [rawLow, rawHigh];
    }

    // Summary UI
    document.getElementById("summary").innerHTML=`
      <table>
        <tr><th>Metric</th><th>Value</th></tr>
        <tr><td>Students</td><td>${n}</td></tr>
        <tr><td>Mean</td><td>${mean.toFixed(2)} (${(mean/maxMarks*100).toFixed(1)}%)</td></tr>
        <tr><td>Standard deviation</td><td>${sd.toFixed(2)}</td></tr>
        <tr><td>Range</td><td>${min} – ${max}</td></tr>
      </table>
    `;

    // Band summary table (Emerging to Exemplary)
    let bandRows = "<tr><th>Band</th><th>Range</th><th>Count</th></tr>";
    for(const [name,[lo,hi]] of Object.entries(bands5)){
      const count = scores.filter(s=>s>=lo && s<=hi).length;
      bandRows += `<tr><td>${name}</td><td>${lo.toFixed(1)} – ${hi.toFixed(1)}</td><td>${count}</td></tr>`;
    }
    document.getElementById("bandsTable").innerHTML = bandRows;

    // 1-9 distribution table
    let stanineRows = "<tr><th>Grade</th><th>Approx. score range</th><th>Count</th></tr>";
    for (let grade = 1; grade <= 9; grade++) {
      const [rawLow, rawHigh] = stanineBands[grade];
      const count = scores.filter(s => s >= rawLow && s < rawHigh).length;
      stanineRows += `<tr>
        <td>${grade}</td>
        <td>${rawLow.toFixed(1)} – ${rawHigh.toFixed(1)}</td>
        <td>${count}</td>
      </tr>`;
    }
    document.getElementById("stanineTable").innerHTML = stanineRows;

    // Student + 5-band table
    let rows = "<tr><th>#</th><th>Score</th><th>Band</th></tr>";
    scores.forEach((s,i)=>{
      const band = Object.entries(bands5).find(([_,[l,h]])=>s>=l && s<=h)?.[0] ?? "N/A";
      rows+=`<tr><td>${i+1}</td><td>${s}</td><td>${band}</td></tr>`;
    });
    document.getElementById("studentsTable").innerHTML=rows;

    // Background colours
    const bandColours5={
      "Emerging":"rgba(220, 68, 5, 0.10)",     // Orange
      "Developing":"rgba(0, 51, 160, 0.10)",   // Blue
      "Secured":"rgba(33, 181, 143, 0.10)",    // Turquoise
      "Proficient":"rgba(255, 181, 0, 0.10)",  // Yellow
      "Exemplary":"rgba(92, 6, 140, 0.10)"     // Purple
    };

    const stanineColours = [
      "rgba(0, 55, 42, 0.08)",  // 1
      "rgba(0, 99, 91, 0.10)",  // 2
      "rgba(0, 51, 160, 0.10)", // 3
      "rgba(33, 181, 143, 0.10)",//4
      "rgba(255, 181, 0, 0.10)", //5
      "rgba(220, 68, 5, 0.10)",  //6
      "rgba(92, 6, 140, 0.10)",  //7
      "rgba(196, 214, 0, 0.10)", //8 lime-ish
      "rgba(255, 107, 107, 0.10)"//9
    ];

    // Plugin for 5-band chart
    const bandPlugin5={
      id:"bandBG5",
      beforeDraw(chart){
        const {ctx, chartArea, scales:{x,y}}=chart;
        ctx.save();
        for(const [name,[lo,hi]] of Object.entries(bands5)){
          const start=Math.max(lo,xMin), end=Math.min(hi,xMax);
          const xStart=x.getPixelForValue(start);
          const xEnd=x.getPixelForValue(end);
          ctx.fillStyle=bandColours5[name];
          ctx.fillRect(xStart,chartArea.top,xEnd-xStart,chartArea.bottom-chartArea.top);

          const mid=(start+end)/2;
          const labelY=y.getPixelForValue(normalPdf(mid,mean,sd));
          ctx.fillStyle="#374151";
          ctx.font="10px system-ui";
          ctx.textAlign="center";
          ctx.fillText(name,(xStart+xEnd)/2,labelY-10);
        }
        ctx.restore();
      }
    };

    // Plugin for 1-9 chart
    const bandPlugin9={
      id:"bandBG9",
      beforeDraw(chart){
        const {ctx, chartArea, scales:{x,y}}=chart;
        ctx.save();
        for(let grade=1; grade<=9; grade++){
          const [loRaw, hiRaw] = stanineBands[grade];
          const start=Math.max(loRaw,xMin), end=Math.min(hiRaw,xMax);
          const xStart=x.getPixelForValue(start);
          const xEnd=x.getPixelForValue(end);
          ctx.fillStyle=stanineColours[grade-1];
          ctx.fillRect(xStart,chartArea.top,xEnd-xStart,chartArea.bottom-chartArea.top);

          const mid=(start+end)/2;
          const labelY=y.getPixelForValue(normalPdf(mid,mean,sd));
          ctx.fillStyle="#374151";
          ctx.font="10px system-ui";
          ctx.textAlign="center";
          ctx.fillText(grade.toString(),(xStart+xEnd)/2,labelY-10);
        }
        ctx.restore();
      }
    };

    // Draw first chart (5 bands)
    const ctx1=document.getElementById("curveChart").getContext("2d");
    if(chartInstance) chartInstance.destroy();

    chartInstance=new Chart(ctx1,{
      type:"line",
      data:{
        datasets:[{
          label:"Bell curve",
          data:xs.map((v,i)=>({x:v,y:ys[i]})),
          borderColor: "#00635B",
          borderWidth:2,
          pointRadius:0,
          tension:0.25
        }]
      },
      options:{
        plugins:{legend:{display:false}, tooltip:{enabled:false}},
        scales:{
          x:{
            type:"linear",
            min:xMin,
            max:xMax,
            title:{display:true,text:`Score (out of ${maxMarks})`},
            ticks:{
              maxTicksLimit:7,
              font:{size:11},
              callback:(v)=>Number.isInteger(v)?v:""
            }
          },
          y:{
            min:0,
            max:maxY*1.25,
            ticks:{
              maxTicksLimit:5,
              font:{size:11},
              callback:v=>v.toFixed(2)
            },
            title:{display:true,text:"Density"}
          }
        }
      },
      plugins:[bandPlugin5]
    });

    // Draw second chart (1-9)
    const ctx2=document.getElementById("stanineChart").getContext("2d");
    if(stanineChartInstance) stanineChartInstance.destroy();

    stanineChartInstance=new Chart(ctx2,{
      type:"line",
      data:{
        datasets:[{
          label:"Bell curve",
          data:xs.map((v,i)=>({x:v,y:ys[i]})),
          borderColor: "#00372A",
          borderWidth:2,
          pointRadius:0,
          tension:0.25
        }]
      },
      options:{
        plugins:{legend:{display:false}, tooltip:{enabled:false}},
        scales:{
          x:{
            type:"linear",
            min:xMin,
            max:xMax,
            title:{display:true,text:`Score (out of ${maxMarks})`},
            ticks:{
              maxTicksLimit:7,
              font:{size:11},
              callback:(v)=>Number.isInteger(v)?v:""
            }
          },
          y:{
            min:0,
            max:maxY*1.25,
            ticks:{
              maxTicksLimit:5,
              font:{size:11},
              callback:v=>v.toFixed(2)
            },
            title:{display:true,text:"Density"}
          }
        }
      },
      plugins:[bandPlugin9]
    });
  }

  function resetInputs() {
    document.getElementById("scoresInput").value = "";
    document.getElementById("maxMarks").value = "";
  }

  async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const app = document.getElementById("appRoot");

    const canvas = await html2canvas(app, { scale: 2 });
    const imgData = canvas.toDataURL("image/png");

    const pdf = new jsPDF("p", "mm", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth - 14;
    const imgHeight = canvas.height * imgWidth / canvas.width;

    let y = 8;
    pdf.addImage(imgData, "PNG", 7, y, imgWidth, Math.min(imgHeight, pageHeight - 16));
    pdf.save("Misk-Bell-Curve.pdf");
  }

  window.onload = generateCurve;
</script>
</body>
</html>
